---
apiVersion: v1
kind: Secret
metadata:
  name: pihole-tls
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURSVENDQWkyZ0F3SUJBZ0lVU1I5aytjWHNubmw3ZDZ4LzFVZ2VnQTAwMENRd0RRWUpLb1pJaHZjTkFRRUwKQlFBd01qRVpNQmNHQTFVRUF3d1FZMkZzWldKdFpuSmxibU5vTG14aGJqRVZNQk1HQTFVRUNnd01ZMkZzWldKdApabkpsYm1Ob01CNFhEVEl3TURneU5ERTRORFkwTUZvWERUSXhNRGd5TkRFNE5EWTBNRm93TWpFWk1CY0dBMVVFCkF3d1FZMkZzWldKdFpuSmxibU5vTG14aGJqRVZNQk1HQTFVRUNnd01ZMkZzWldKdFpuSmxibU5vTUlJQklqQU4KQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBeTBCTW5aaWpUL1djTTVycitqbHExOG5jR3BvZwo4c2NyMDAwcFdtMGUraGZsaHdRaFc5WmkyZkU3b0NRc2pTck9JTnVtUnlRQWRSODExWTdxbmRWWCtwNHRRYlp0CjVwNXRTTnhQNm9xaU9YMjdiRUh4SFdYYkhyY0p5cWNmTmh6T1IyWkNvUXJ5eDZBUXpjZFRvVFdTR0E0ZjlKREsKdVZCSXhzcGVmSnhOSE94c28rOXJmY0J0NVRWS3hzdUw5d2VkeG8zQkR1Z3lqU0dRbityMkJ5N0tVL1RrYjVIbQpIV3RMTUNKYTJydUVaSFppNHYzYUpDTDJ5emN1SWMvUXI3U3ZmSXBkekxJd0xxWHFNdFhxcTgwZDJTNTBDSnNDCmowKzF6dWlud2pSZlB6MEpJL1RWeTF1WjhFR1ZCcGhQNE42WVJ1Z1RBUkpnTHdwTnJDWWVNSmlva1FJREFRQUIKbzFNd1VUQWRCZ05WSFE0RUZnUVVWejZsRlFrNlVUVWUxRXcxUmVXNUdGL3ErZzh3SHdZRFZSMGpCQmd3Rm9BVQpWejZsRlFrNlVUVWUxRXcxUmVXNUdGL3ErZzh3RHdZRFZSMFRBUUgvQkFVd0F3RUIvekFOQmdrcWhraUc5dzBCCkFRc0ZBQU9DQVFFQVM3YjhTSU9uOW5yTXdhU0Naa3Q2WXJCTzBuTUZPdWJ2NU5jcmZ5OTJhblZra05iSmZ2T3oKYXQxRDJjazBIUFZVcWN3UTRWRmNTbG1FQUZETytzMk1xcXJsMm1sWld3djRIVEdiSloxa01vUmtObzJSRmpqMQpSRFd1SUlKLzE5aWN4S0JJZmZ1bW5MU1plQ1BZcEFXSVp2MXd3MUtyWStINlIwOGVvWkh6dWNTYi9rRlYwMUczCnpuTjEydHlQUHY1eGMzU0lrV2crTlBPenpDSU5IV0gxRktzaVkrek8vRW8xOGxyeWhHdjdjMFJNc1NheFVYMFoKWUhGcmNVZEN4b0hNNzk4eHk1dk9sUVc4VHdTa0tzVTMvR3FGOXFEeWZDWWt5QUYvNmtJMEJjTGxDRFErWUxkVwo1QjdvQkZPN2tyMzUzT3FQeGFrWkF3VmRXSTNnTG5Na0RBPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRExRRXlkbUtOUDlad3oKbXV2Nk9Xclh5ZHdhbWlEeXh5dlRUU2xhYlI3NkYrV0hCQ0ZiMW1MWjhUdWdKQ3lOS3M0ZzI2WkhKQUIxSHpYVgpqdXFkMVZmNm5pMUJ0bTNtbm0xSTNFL3FpcUk1ZmJ0c1FmRWRaZHNldHduS3B4ODJITTVIWmtLaEN2TEhvQkROCngxT2hOWklZRGgvMGtNcTVVRWpHeWw1OG5FMGM3R3lqNzJ0OXdHM2xOVXJHeTR2M0I1M0dqY0VPNkRLTklaQ2YKNnZZSExzcFQ5T1J2a2VZZGEwc3dJbHJhdTRSa2RtTGkvZG9rSXZiTE55NGh6OUN2dEs5OGlsM01zakF1cGVveQoxZXFyelIzWkxuUUltd0tQVDdYTzZLZkNORjgvUFFrajlOWExXNW53UVpVR21FL2czcGhHNkJNQkVtQXZDazJzCkpoNHdtS2lSQWdNQkFBRUNnZ0VBWFpLd3N5MStvbVZWRUgwV2Z4RElHNmlYYUxma3kyRGUwRjBKMk5POEd5KzkKUURlcWsvbFRjVHNhVkZQVEh2ckNBMmFjV3N3OFdhK1F2VTBhdnFkbDViL0UzaWY2Mk4yL09uZ1RZc3VJZkNkaQpqaWlkdFFjYnBqeG1pYUgvUUk1cWVYeWUyRDJPSUZHVTZ1Z0ZuSVpwU0NIWW5HTzhzU3hCRlNROTgraVJwK3B1Ckt2emd2UkpyaGVqb1NOVzdSamsxekR3OVlLNzdzMDk1dVAwYThlamZ2S3RFWWg2VVphRk1QcFdUVXA0MC8xTU0KSGV3QlBSeHdrNnR4OVM5b1B2Y0U0Q0JDYWlHMGNpOXBFTkNVemdTZCtGdFFuS1FiVGVRMFBJbW5hcHhPNU81ago4b2VOd3d6R1pmelU0bEhuU2pOUWROMURZYm5jMFk0Z1loTncvUHBDc1FLQmdRRDNxZkJHd3VTS2tWMlZJSU5SClVCUkZkbUNEci9yVTBrKzhJUStQTCtXNnVrVmJ5bHIzZHk5UUNwZkM1V2lwVCs5bFRRZjdXVFdOWmhrUmYvMksKVW1GdC94TVFjTTdaM3luYXpXQmVkcVpZNk1mY09YR3VTNzluVmRDQUltS2JxcTFiTzZqL05Ec0NLOXI1L1RsVApPc3ZZbkpoY3UreTZtd1gvYlpLYWRjVzNtd0tCZ1FEU0Y2ck8yU3hpdXhTbEcwa3RzQndqb01PVElFNmhueXFqCmxmcXhuY3R3ak4yRENLRkdZUll3K1hrelpXa09FNzhQNTR4VDhKWE5MSXFpV0c4cFhGamtHUkRKSFArZXhVbUkKSFZOS0xMajZQNk1IbXBXUGI2ZUFxWUpJR2ZlZ2VpVmdMZ3RyaG9KK2JPbkoyR2hmMFI2U0hqS1hLQ2NlVmxNNwpFVHhNeDRZQlF3S0JnRFpDUHVmaHp0d2syTkhSRzdQMnpWb2lneWFXcVdkeTVCRWRWU0ZUcHdydndENUo2UUFLClZvMDhwTjhJRDVQNGRVUkdTaGRoQmdDQ2U3OS93UFpLOGhsOUpwb1ZmTnZ5cm1MSFYvT2FIdnVmbEJuRlpBaUIKZzkrSngzSXJGbHR3V3laL3ZaaWJ3c25JL2VLQy9jb2tPWUN0WGh3Qzkrd3lCbkJkZXg3bjZuYzlBb0dCQUxvUApLNzQwcHhKcERFZU1lcXB6cFBnSWtDdmtHTDhaN3ZFaENmdnkreENhTURLem1lQnlhdXpFZzRuNDdha0I0OXQ1Ci9OVDU1RERvbVg1ZFExVWw2N05XWDM4OHAwVTlBM29BUHBzYU1GZXZzL292OVBRcXRmVkVLWlVoS2lSOUNFeTkKZW0rbm1Ebk95dDF2UWtCWk92Rzh2S0VSZGxOdnNCWkhsVmVKL0N0eEFvR0JBT2RaUi9WRUtFSEJjeFAzcVR0UQpQS2pmNEdhUFJyT3lZckFVTnR0cDdyc0VmNFAwaUc2U2M1V2dpWHRvd1R0SWpkam9zTmNuTVpOZmRlNnlHWXpXClFJOE9DOS80Y08zN2lCZy9WVG5tbHV5OE8wVUx0a1BDaldtbDVrUEE1Qlc4Vk50OW8yT0hKbU9uSnA4QnlnUkkKV2ZpY2R0WXhDd1JOVjQ5VHBFSWdMSDBWCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
---
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: pihole-ingress
  labels:
    app: pihole
  annotations:
    traefik.frontend.rule.type: PathPrefixStrip
spec:
  tls:
    - hosts:
      - bramble-s1
      - bramble-s2
      secretName: pihole-tls
  rules:
    - host: bramble-s1
      http:
        paths:
        - path: /pihole
          backend:
            serviceName: pihole-0-svc
            servicePort: 80
    - host: bramble-s2
      http:
        paths:
        - path: /pihole
          backend:
            serviceName: pihole-1-svc
            servicePort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: pihole-0-svc
  labels:
    app: pihole
    svc: lb
spec:
  selector:
    statefulset.kubernetes.io/pod-name: pihole-0
  externalIPs:
    - 192.168.100.101
  ports:
    - port: 53
      protocol: TCP
      name: dns-tcp
    - port: 53
      protocol: UDP
      name: dns-udp
    - port: 80
      protocol: TCP
      name: http
---
apiVersion: v1
kind: Service
metadata:
  name: pihole-1-svc
  labels:
    app: pihole
    svc: lb
spec:
  selector:
    statefulset.kubernetes.io/pod-name: pihole-1
  externalIPs:
    - 192.168.100.103
  ports:
    - port: 53
      protocol: TCP
      name: dns-tcp
    - port: 53
      protocol: UDP
      name: dns-udp
    - port: 80
      protocol: TCP
      name: http   
---
apiVersion: v1
kind: Service
metadata:
  name: pihole
  labels:
    app: pihole
spec:
  clusterIP: None
  selector:
    app: pihole
  ports:
    - port: 53
      protocol: TCP
      name: dns-tcp
    - port: 53
      protocol: UDP
      name: dns-udp
    - port: 80
      protocol: TCP
      name: http
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: pihole
  labels:
    app: pihole
spec:
  selector:
    matchLabels:
      app: pihole
  serviceName: "pihole"
  replicas: 2
  template:
    metadata:
      labels:
        app: pihole
    spec:
      terminationGracePeriodSeconds: 10
      dnsPolicy: None
      dnsConfig:
        nameservers:
          - 127.0.0.1
          - 1.1.1.1
      containers:
      - name: dns
        image: pihole/pihole:latest
        imagePullPolicy: Always
        env:
        - name: TZ
          value: "America/Chicago"
        - name: WEBPASSWORD
          valueFrom:
            secretKeyRef:
              key: password
              name: pihole.password-secret
        startupProbe:
          exec:
            command:
            - pihole
            - status
          failureThreshold: 6
          periodSeconds: 10
        livenessProbe:
          httpGet:
            path: /admin/
            port: 80
          initialDelaySeconds: 60
          failureThreshold: 6
          periodSeconds: 10
          timeoutSeconds: 5
        ports:
        - containerPort: 80
          protocol: TCP
        - containerPort: 53
          hostPort: 53
          protocol: TCP
        - containerPort: 53
          hostPort: 53
          protocol: UDP
        volumeMounts:
        - name: etc
          mountPath: /etc/pihole

      # - name: exporter
      #   image: ekofr/pihole-exporter:latest
      #   imagePullPolicy: IfNotPresent
      #   env:
      #   - name: PIHOLE_HOSTNAME
      #     valueFrom:
      #       fieldRef:
      #         fieldPath: metadata.name
      #   - name: PIHOLE_PASSWORD
      #     valueFrom:
      #       secretKeyRef:
      #         key: password
      #         name: pihole.password-secret
      #   - name: INTERVAL
      #     value: "30s"
      #   - name: PORT
      #     value: "9617"
      #   ports:
      #   - containerPort: 9617
      #     protocol: TCP
          
  volumeClaimTemplates:
  - metadata:
      name: etc
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: "local-path"
      resources:
        requests:
          storage: 500Mi